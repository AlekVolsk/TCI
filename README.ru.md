# TCI – Telegram Content Import

### Системный плагин для CMS Joomla!, обеспечивающий импорт постов из Telegram в материалы Joomla. <br>CLI-решение. Базируется на работе сервиса https://tg.i-c-a.su/.<br><br>

[![Заказать](https://img.shields.io/badge/заказать-$75-28A5F5.svg?style=for-the-badge)](https://alekvolsk.pw/ru/#callback)<br><br>

![Joomla](https://img.shields.io/badge/joomla-3.7+-1A3867.svg?style=for-the-badge)
![Php](https://img.shields.io/badge/php-5.6+-8892BF.svg?style=for-the-badge)
![Last Update](https://img.shields.io/badge/last_update-2021.01.04-28A5F5.svg?style=for-the-badge)
![Version](https://img.shields.io/badge/version-1.1.4-1e87f0.svg?style=for-the-badge)

Плагин совместим с Joomla! 4.

## Краткая инструкция по запуску плагина

Проверьте, чтобы плагин был опубликован.

Укажите в параметрах плагина системное имя публичного telegram-канала (без символа @).

Плагин вызывается исключительно из командной строки. Создайте cron-запись с периодом выполнения в минутах и значением, указанным в параметре плагина «Период», с адресом:

```
wget -O '{ваш домен}/index.php?option=com_ajax&group=system&plugin=tci&method=post&format=raw[дополнительные параметры]'

```

Вы можете дополнительно указать параметры:

```
&channel={имя канала}&limit={лимит постов}&period={период в минутах}&catid={id категории материалов Joomla}&lang={язык материала}&featured={0|1}
```

для импорта постов с канала, отличного от указанного в параметрах плагина. При отсутствии любого из этих параметров будут применяться их аналоги из параметров плагина.

---

## Параметры плагина

**Телеграм-сервер** \*. URL-адрес сервиса, посредством которого производится получение постов из Telegram. Значение по умолчанию: `https://tg.i-c-a.su/`.

**Системное имя канала** \*. Системное имя telegtram-канала (без символа @), с которого предполагается импортировать посты.

**Лимит получаемых постов за одну обработку** \*. Указывается общее количество получаемых от сервиса постов. Значение по умолчанию: `10`. *ВАЖНО: [что является постом в Telegram?](#tgpost).*

**Период, за который берутся посты с канала на момент обращения, минуты** \*. Время указывается в минутах. Момент обращения – подразумевается момент запуска плагина. Значение по умолчанию: `60`.

**Обрабатывать посты, пересылаемые с других каналов**. Принимаемые значения: `Да|Нет`. Значение по умолчанию: `Нет`.

**Категория материалов** \*. Категория материалов Joomla, в которую будет производится импорт материалов. Значение по умолчанию: `Uncategorized` (без категории, ID=2).

**Язык материалов**. Значение по умолчанию: для всех языков.

**Автор материалов**. Пользователь Joomla, выступающий как автор материалов, импортируемых из Telegram. Значение по умолчанию: пользователь, от имени которого создавался сайт.

**Состояние материалов при импорте**. Принимаемые значения: `Не опубликовано|Опубликовано`. Значение по умолчанию: `Не опубликовано`.

**Добавлять ID поста в конец алиаса**. Позволит импортировать посты с одинаковыми заголовками. Принимаемые значения: `Да|Нет`. Значение по умолчанию: `Нет`.

**Помещать материал в избранные**. Принимаемые значения: `Да|Нет`. Значение по умолчанию: `Нет`.

**Преобразовывать хештеги из поста в метки Joomla**. Принимаемые значения: `Да|Нет`. Значение по умолчанию: `Нет`.

**Преобразовывать хештеги в теле материала в ссылки на теги**. Принимаемые значения: `Да|Нет`. Значение по умолчанию: `Нет`. Этот параметр отображается только вслучае включения параметра «Преобразовывать хештеги из поста в метки Joomla».

**Формировать meta description**. Принимаемые значения: `Да|Нет`. Значение по умолчанию: `Нет`. <br>*Особенности формирования meta description*: из тела материала берутся первые 150 символов текста, из которого предварительно вырезаны иконографические символы (символы-иконки), производится обрезка до ближайшего пробела с конца строки и в случае, когда строка не является цельным предложением, добавляется многоточие.

**Папка импортируемых из постов изображений**. Папка, в которую будут импортированы изображения из поста в Telegram. Значение по умолчанию: корень папки `images` в корне сайта. *ВАЖНО: [Особенности формирования материала Joomla](#jarticle).*

**Действия при ошибке скачивания изображения**. Принимаемые значения: `Пропускать изображение|Схранять оригинальную ссылку`. Значение по умолчанию: `Пропускать изображение`. *ВАЖНО: [Особенности формирования материала Joomla](#jarticle).*

**Действия с изображениями постов-галерей**. Принимаемые значения:

- `Оставлять в контенте материала`,
- `Первое изображение – в интро и в основное изображение материала`,
- `Первое изображение – в интро, второе – в основное изображение материала`.

Значение по умолчанию: `Оставлять в контенте материала`. *ВАЖНО: [Особенности формирования материала Joomla](#jarticle).*

**Добавлять подпись для изображений**. Влияет только на интро и основное изображения материала. Принимаемые значения: `Да|Нет`. Значение по умолчанию: `Нет`.

---

## Параметры CLI

Дополнительные cli-параметры обусловлены возможным импортом постов из более чем из одного telegram-канала.

Корректное указание любого из нижепреведённых параметров переопределяет значение соответствующего параметра плагина.

**channel** – Системное имя канала.

**limit** – Лимит получаемых постов за одну обработку.

**period** – Период, за который берутся посты с канала на момент обращения, минуты, указываются числом

**catid** – ID категории материалов, указывается числом. ID можно посмотреть в административной панели Joomla, на странице списка категорий материалов.

**lang** – Язык материалов, указывается системная константа (напрмер: `en-GB`, `ru-RU`) либо символ `*` для указания значения **для всех языков**.

**featured** – Помещать материал в избранные. Указывается числом, значение `0` – Нет, `1` – Да, иные значения игнорируются и берётся значение из параметра плагина.

**userid** – Установить ID пользователя Joomla как автора материала.

---

## Особенности работы сервиса https://tg.i-c-a.su/

Сервис имеет следующие лимиты:

- Работа только с публичными чатами.
- Не белее 15 запросов в минуту.
- Не более 100 постов за 1 запрос.
- Временный бан за любую ошибку, например: неверное название канала или закрытый канал.

Сервис имеет свободный исходный код (ссылка доступна на официальной странице сервиса) и позволяет поднять на собственном сервере свой экземпляр сервиса, что настоятельно рекомендуется, если у вас предполагается импор большого количества постов за малый временной период.

Бан имеет накопительное время: попытка обращения к сервису во время действия бана автоматически увелививает продолжительность бана в два раза!

---

## <a name="tgpost"></a>Что является постом в Telegram

Пост в Telegram – это более сложная структура, нежели классическое визуальное представление того, что обычно считается постом. Технически визуальный пост – это сразу несколько постов. Например, пост-галерея из 10 изображений - это сразу 10 постов, т.е. каждое изображение - это отдельный пост, просто они сгруппированы по определённому признаку. При импорте эти изображения будут также сгруппированы в один материал Joomla.

Почему это важно? Потому что сервис, используемый по умолчанию, имеет ограничение на лимит запросов. Изображения получаются отдельными запросами и всё это происходит за один прогон плагина. Учитывайте это при расчёте периода: вполне может оказаться, что импортируя 10 постов галерей, вы на выходе получите 10 галерей по 10 изображений, что в итоге выльется в 101 запрос (1 запрос – на получение списка постов), что явно больше указанного ограничения сервиса в 15 запросов.

### Какие типы постов игнорируются

Игнорируются системные посты самого Telegram, скрытые посты (скрываются администратором канала), посты-голосования. Также игнорируются видеоролики из постов-галерей.

---

## <a name="jarticle"></a>Особенности формирования материала Joomla

Плагин импортирует только текст и изображения.

Текст разбивается на абзацы.

Из первого абзаца формируется заголовок. Из заголовка вырезаются все иконографические символы, обрезается до 100 символов (ограничение Joomla на зоголовок материала), затем обрезается до первого пробела с конца строки. Из получившейся строки формируется alias материала, по которому уникализируется последний: если материал с таким alias уже существует, то он пропускается.

Если первый абзац подвергался обрезки при формировании заголовка, он полностью в необработанном виде формирует интро материала, в противном случае интро материала формируется из второго абзаца.

Все последующие абзацы формируют основную часть материала.

Если абзацев менее трёх, оснавная часть матерала не формируется.

Если абзацев всего один, он полностью формирует интро материала.

Изображения из постов-галерей, которые не формируют интро- и основное изображения материала, добавляются только в основную часть материала, каждое изображение оборачивается в отдельный абзац. Каких-либо редактирующих действий над изображениями не производится.

В случае включения опции плагина *Преобразовывать хештеги из поста в метки Joomla* все найденные хештеги преобразуются в метки Joomla и присваиваются материалу. Ранее существующие метки повторно не создаются.

В случае включения опции плагина *Преобразовывать хештеги в теле материала в ссылки на теги* все найденные хештеги будут преобразованы в ссыклки на соответствующие метки. В этом случае рекомендуется отключить показ меток материала в опциях материала (или в общих опциях компонента материалов).

---

### Дополнительная информация

Плагин формирует ежемесячный лог посредством стандартного логгера Joomla. Имя файла лога формируется по маске `tci_{Год-месяц}.php.log`. Для просмотра лога из административной панели Joomla можно воспользоваться компонентом [View logs](https://github.com/AlekVolsk/View-logs/releases/latest).

Ссылки на видеородики с YouTube в уже импортированных материалах можно преобразовать контент-плагином [YtVideo](https://github.com/AlekVolsk/ytvideo/releases/latest).

---

**Стоимость решения — $75 USD**

Заказ осуществляется посредством обращения через форму обратной связи на личной страничке автора.

При заполнении формы обязательно укажите свой username в Telegram, а в тексте обращения "Заказ TCI".

[![Заказать](https://img.shields.io/badge/заказать-$75-28A5F5.svg?style=for-the-badge)](https://alekvolsk.pw/ru/#callback)

Поддержка осуществляется в личной переписке с автором в Telegram.
