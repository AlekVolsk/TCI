# TCI – Telegram Content Import

### Системный плагин для CMS Joomla!, обеспечивающий импорт постов из Telegram в материалы Joomla. <br>CLI-решение. Базируется на работе сервиса https://tg.i-c-a.su/.<br><br>

[![Заказать](https://img.shields.io/badge/заказать-$75-28A5F5.svg?style=for-the-badge)](https://alekvolsk.pw/ru/#callback)
[![Demo](https://img.shields.io/badge/-demo-555555.svg?style=for-the-badge)](https://forester.alekvolsk.info/)<br><br>

![Joomla](https://img.shields.io/badge/joomla-3.7+-1A3867.svg?style=for-the-badge)
![Php](https://img.shields.io/badge/php-5.6+-8892BF.svg?style=for-the-badge)
![Last Update](https://img.shields.io/badge/last_update-2021.03.15-28A5F5.svg?style=for-the-badge)
![Version](https://img.shields.io/badge/version-1.3.2-1e87f0.svg?style=for-the-badge)

Плагин совместим с Joomla! 4.

## Краткая инструкция по запуску плагина

Проверьте, чтобы плагин был опубликован.

Укажите в параметрах плагина системное имя публичного telegram-канала (без символа @).

Плагин вызывается исключительно из командной строки. Создайте cron-запись с периодом выполнения в минутах и значением, указанным в параметре плагина «Период», с адресом:

```
wget -q -O -- "{ваш домен}/index.php?option=com_ajax&group=system&plugin=tci&method=post&format=raw&key={ключ безопасности}[дополнительные параметры]"

```

Ключ безопасности будет автоматически сформирован при первом сохранении параметров плагина.

Вы можете дополнительно указать параметры:

```
&channel={имя канала}&limit={лимит постов}&period={период в минутах}&catid={id категории материалов Joomla}&lang={язык материала}&featured={0|1}&userid={ID пользователя Joomla}
```

для импорта постов с канала, отличного от указанного в параметрах плагина. При отсутствии любого из этих параметров будут применяться их аналоги из параметров плагина.

---

## Параметры плагина

**Ключ безопасности**. Необходим для защиты сайта от возможных DDOS-атак. Автоматически формируется при первом сохранении плагина.

**Телеграм-сервер** \*. URL-адрес сервиса, посредством которого производится получение постов из Telegram. Значение по умолчанию: `https://tg.i-c-a.su/`.

**Системное имя канала** \*. Системное имя telegtram-канала (без символа @), с которого предполагается импортировать посты.

**Лимит получаемых постов за одну обработку** \*. Указывается общее количество получаемых от сервиса постов. Значение по умолчанию: `10`. *ВАЖНО: [что является постом в Telegram?](#tgpost)*

**Период, за который берутся посты с канала на момент обращения, минуты** \*. Время указывается в минутах. Момент обращения – подразумевается момент запуска плагина. Значение по умолчанию: `60`.

**Обрабатывать посты, пересылаемые с других каналов**. Принимаемые значения: `Да|Нет`. Значение по умолчанию: `Нет`.

**Категория материалов** \*. Категория материалов Joomla, в которую будет производиться импорт материалов. Значение по умолчанию: `Uncategorized` (без категории, ID=2).

**Язык материалов**. Значение по умолчанию: для всех языков.

**Автор материалов**. Пользователь Joomla, выступающий как автор материалов, импортируемых из Telegram. Значение по умолчанию: пользователь, от имени которого создавался сайт.

**Состояние материалов при импорте**. Принимаемые значения: `Не опубликовано|Опубликовано`. Значение по умолчанию: `Не опубликовано`.

**Добавлять ID поста в конец алиаса**. Позволит импортировать посты с одинаковыми заголовками. Принимаемые значения: `Да|Нет`. Значение по умолчанию: `Нет`.

**Пропускать посты без текстового контента**. Позволит пропускать посты-изображения и галереи, если в них отсутствует текстовое описание. Принимаемые значения: `Да|Нет`. Значение по умолчанию: `Нет`.

**Помещать материал в избранные**. Принимаемые значения: `Да|Нет`. Значение по умолчанию: `Нет`.

**Преобразовывать хештеги из поста в метки Joomla**. Принимаемые значения: `Да|Нет`. Значение по умолчанию: `Нет`.

**Преобразовывать хештеги в теле материала в ссылки на теги**. Принимаемые значения: `Да|Нет`. Значение по умолчанию: `Нет`.
Этот параметр отображается только в случае включения параметра «Преобразовывать хештеги из поста в метки Joomla».

**Формировать meta description**. Принимаемые значения: `Да|Нет`. Значение по умолчанию: `Нет`. <br>*Особенности формирования meta description*: из тела материала берутся первые 150 символов текста, из которого предварительно вырезаны иконографические символы (символы-иконки), производится обрезка до ближайшего пробела с конца строки и в случае, когда строка не является цельным предложением, добавляется многоточие.

**Папка импортируемых из постов изображений**. Папка, в которую будут импортированы изображения из поста в Telegram. Значение по умолчанию: корень папки `images` в корне сайта. *ВАЖНО: [Особенности формирования материала Joomla](#jarticle).*

**Действия при ошибке скачивания изображения**. Принимаемые значения: `Пропускать изображение|Сохранять оригинальную ссылку`. Значение по умолчанию: `Пропускать изображение`. *ВАЖНО: [Особенности формирования материала Joomla](#jarticle).*

**Действия с изображениями постов-галерей**. Принимаемые значения:

- `Оставлять в контенте материала`,
- `Первое изображение – во вводное и в основное изображение материала`,
- `Первое изображение – во вводное, второе – в основное изображение материала`.

Значение по умолчанию: `Оставлять в контенте материала`. *ВАЖНО: [Особенности формирования материала Joomla](#jarticle).*

**Добавлять подпись для изображений**. Влияет только на вводное и основное изображения материала. Принимаемые значения: `Да|Нет`. Значение по умолчанию: `Нет`.

**Подключать комментарии из поста**. Позволяет подключить живые комментарии, прикреплённые к посту. При наличии авторизации из телеграма позволяет полноценно использовать на сайте систему комментариев телеграма. Подключение производится посредством загрузки соответствующего скрипта API Telegram.
Подключение производится только в тех случаях, когда на момент импорта у поста были активны комментарии, а в поле примечаний к материалу сохранена структура с информацией о посте.
В разметке материала блок комментариев оборачивается в контейнер с классом `telegram-comments`. Поддерживается подключение тёмной темы оформления. Плагин не содержит собственных стилей по оформлению блока комментариев.
Принимаемые значения: `Да|Нет`. Значение по умолчанию: `Нет`.

**Тёмная тема оформления**. Подключение тёмной темы оформления блока комментариев. Принимаемые значения: `Да|Нет`. Значение по умолчанию: `Нет`.
Этот параметр отображается только в случае включения параметра «Подключать комментарии из поста».

---

## Параметры CLI

Дополнительные cli-параметры обусловлены возможным импортом постов из более чем из одного telegram-канала.

Корректное указание любого из нижеприведённых параметров переопределяет значение соответствующего параметра плагина.

**channel** – Системное имя канала.

**limit** – Лимит получаемых постов за одну обработку.

**period** – Период, за который берутся посты с канала на момент обращения, минуты, указываются числом

**catid** – ID категории материалов, указывается числом. ID можно посмотреть в административной панели Joomla, на странице списка категорий материалов.

**lang** – Язык материалов, указывается системная константа (например: `en-GB`, `ru-RU`) либо символ `*` для указания значения **для всех языков**.

**featured** – Помещать материал в избранные. Указывается числом, значение `0` – Нет, `1` – Да, иные значения игнорируются и берётся значение из параметра плагина.

**userid** – Установить ID пользователя Joomla как автора материала.

---

## Особенности работы сервиса https://tg.i-c-a.su/

Сервис имеет следующие лимиты:

- Работа только с публичными чатами.
- Не белее 15 запросов в минуту.
- Не более 100 постов за 1 запрос.
- Временный бан за любую ошибку, например: неверное название канала или закрытый канал.

Сервис имеет свободный исходный код (ссылка доступна на официальной странице сервиса) и позволяет поднять на собственном сервере свой экземпляр сервиса, что настоятельно рекомендуется, если у вас предполагается импорт большого количества постов за малый временной период.

!Бан имеет накопительное время: попытка обращения к сервису во время действия бана автоматически увеличивает продолжительность бана в два раза!

---

## <a name="tgpost"></a>Что является постом в Telegram

Пост в Telegram – это более сложная структура, нежели классическое визуальное представление того, что обычно считается постом. Технически, визуальный пост – это сразу несколько постов. Например, пост-галерея из 10 изображений - это сразу 10 постов, т.е. каждое изображение - это отдельный пост, просто они сгруппированы по определённому признаку. При импорте эти изображения будут также сгруппированы в один материал Joomla.

Почему это важно? Потому что сервис, используемый по умолчанию, имеет ограничение на лимит запросов. Изображения получаются отдельными запросами и всё это происходит за один прогон плагина. Учитывайте это при расчёте периода: вполне может оказаться, что импортируя 10 постов галерей, вы на выходе получите 10 галерей по 10 изображений, что в итоге выльется в 101 запрос (1 запрос – на получение списка постов), что явно больше указанного ограничения сервиса в 15 запросов.

### Какие типы постов игнорируются

Игнорируются системные посты самого Telegram, скрытые посты (скрываются администратором канала), посты-голосования, аудиозаписи и видеоролики. Также игнорируются видеоролики из постов-галерей.

---

## <a name="jarticle"></a>Особенности формирования материала Joomla

Плагин импортирует только текст и изображения.

Текст разбивается на абзацы.

Из первого абзаца формируется заголовок. Из заголовка вырезаются все иконографические символы, обрезается до 100 символов (ограничение Joomla на заголовок материала), затем обрезается до первого пробела с конца строки. Из получившейся строки формируется alias материала, по которому уникализируется последний: если материал с таким alias уже существует, то он пропускается.

Если первый абзац подвергался обрезки при формировании заголовка, он полностью в необработанном виде формирует вводную часть материала, в противном случае вводная часть материала формируется из второго абзаца.

Все последующие абзацы формируют основную часть материала.

Если абзацев менее трёх, основная часть материала не формируется.

Если абзацев всего один, он полностью формирует вводную часть материала.

Изображения из постов-галерей, которые не формируют вводное и основное изображения материала, добавляются только в основную часть материала, каждое изображение оборачивается в отдельный абзац. Каких-либо редактирующих действий над изображениями не производится.

В случае включения опции плагина *Преобразовывать хештеги из поста в метки Joomla* все найденные хештеги преобразуются в метки Joomla и присваиваются материалу. Ранее существующие метки повторно не создаются.

В случае включения опции плагина *Преобразовывать хештеги в теле материала в ссылки на теги* все найденные хештеги будут преобразованы в ссылки на соответствующие метки. В этом случае рекомендуется отключить показ меток материала в опциях материала (или в общих опциях компонента материалов).

В поле «Примечание» сохраняется JSON-структура о телеграм-посте, которую могут использовать сторонние расширения при работе с материалом. Структура представляет из себя объект с именем `tci` с набором полей. Поля структуры содержат:

- `channelid` – id канала,
- `channelname` – системное имя канала,
- `channeltitle` – публичный заголовок канала,
- `postid` – id поста в канале,
- `replies` – наличие прикреплённых к посту комментариев.

Эта структура необходима для корректной работы функционала подключения блока комментариев. Также её могут, не изменяя, использовать иные кастомые сторонние решения.

---

### Предварительная обработка контента материала перед его сохранением

Вы можете обработать контент материала перед его сохранением сторонним плагином на событие `onContentBeforeData`.

ВАЖНО: плагин должен быть системным! Контентный плагин отрабатывает один раз за сессию и в итоге будет обработан только 1 материал, остальные будут пропущены: повторно контентный плагин просто не запустится, так устроена Joomla.

Плагин принимает на входе 2 параметра:

- `(string) $context` – передаётся значение `com_plugins.plugin.system.tci`, вы должны проверить контекст исключительно на это значение, чтобы точно знать, что вы обрабатываете контент материала, импортируемого данным плагином;
- `(array) $data = []` – стандартный массив объекта материала, передаётся *не по ссылке*.

Ожидается возвращаемое значение в виде массива объекта материала, чтобы эти изменения были применены либо false в ином случае.

Пример реализации функции события:

```php
public function onContentBeforeData($context, $data = [])
{
    if ($context !== 'com_plugins.plugin.system.tci') {
        return false;
    }

    // change your's data

    return $data;
}
```

---

### Дополнительная информация

Плагин формирует ежемесячный лог посредством стандартного логгера Joomla. Имя файла лога формируется по маске `tci_{Год-месяц}.php.log`. Для просмотра лога из административной панели Joomla можно воспользоваться компонентом [View logs](https://github.com/AlekVolsk/View-logs/releases/latest).

Ссылки на видеоролики с YouTube в уже импортированных материалах можно преобразовать контент-плагином [YtVideo](https://github.com/AlekVolsk/ytvideo/releases/latest).

---

**Стоимость решения — $75 USD**

Вы можете опатить в любой валюте мира, кроме биткойнов, по курсу на момент оплаты.

Заказ осуществляется посредством обращения через форму обратной связи на личной страничке автора.

При заполнении формы обязательно укажите свой username в Telegram, а в тексте обращения "Заказ TCI".

[![Заказать](https://img.shields.io/badge/заказать-$75-28A5F5.svg?style=for-the-badge)](https://alekvolsk.pw/ru/#callback)

Поддержка осуществляется в личной переписке с автором в Telegram.
